{% extends "./base.html" %}
{% block title %}KUCCPS Course Checker | News & Updates{% endblock %}

{% block links %}
<link rel="canonical" href="{{ get_canonical_url('all_news') }}" />
<meta name="description" content="Latest news and updates about KUCCPS courses, admissions, and educational opportunities in Kenya.">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "name": "KUCCPS Course Checker News",
  "description": "Latest news, updates, and announcements about KUCCPS courses and educational opportunities",
  "publisher": {
    "@type": "Organization",
    "name": "KUCCPS Courses Checker",
    "url": "https://www.kuccpscourses.co.ke/",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.kuccpscourses.co.ke/static/images/logo.png"
    }
  },
  "mainEntity": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://www.kuccpscourses.co.ke/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "News",
        "item": "https://www.kuccpscourses.co.ke/news"
      }
    ]
  }
}
</script>
<style>
    .news-hero {
        background: var(--gradient-red);
        color: var(--white);
        padding: 60px 0 40px;
        text-align: center;
    }
    
    .news-hero h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 1rem;
    }
    
    .news-filters {
        background: var(--white);
        padding: 20px;
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-light);
        margin-bottom: 30px;
    }
    
    .news-article {
        margin-bottom: 30px;
        animation: fadeInUp 0.5s ease;
    }
    
    .article-card {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-light);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .article-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-medium);
    }
    
    .article-featured {
        border-left: 5px solid var(--primary-yellow);
    }
    
    .article-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
    }
    
    .article-body {
        padding: 25px;
    }
    
    .article-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--dark-grey);
        margin-bottom: 15px;
        line-height: 1.4;
    }
    
    .article-content {
        color: var(--medium-grey);
        line-height: 1.7;
        margin-bottom: 20px;
    }
    
    .article-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--light-grey);
    }
    
    .article-date {
        color: var(--medium-grey);
        font-size: 0.9rem;
    }
    
    .article-views {
        color: var(--medium-grey);
        font-size: 0.9rem;
    }
    
    .article-views i {
        margin-right: 5px;
    }
    
    .read-more-btn {
        background: var(--gradient-red);
        color: var(--white);
        border: none;
        padding: 8px 20px;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .read-more-btn:hover {
        background: var(--primary-red);
        color: var(--white);
        transform: translateY(-2px);
    }
    
    .no-news {
        text-align: center;
        padding: 60px 20px;
    }
    
    .no-news-icon {
        font-size: 4rem;
        color: var(--light-grey);
        margin-bottom: 20px;
    }
    
    .news-loading {
        text-align: center;
        padding: 40px;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block hero %}
<section class="news-hero">
    <div class="container">
        <h1><i class="fas fa-newspaper me-3"></i>News & Updates</h1>
        <p class="lead">Stay updated with the latest announcements, deadlines, and important information from KUCCPS</p>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Filters -->
    <div class="news-filters">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter News</h5>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm active" onclick="filterNews('all')">
                        All News
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="filterNews('featured')">
                        <i class="fas fa-star me-1"></i>Featured
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="filterNews('recent')">
                        <i class="fas fa-clock me-1"></i>Recent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- News Articles -->
    <div class="row" id="allNewsContainer">
        <!-- News articles will be loaded here dynamically -->
        <div class="col-12 news-loading">
            <div class="spinner-border spinner-custom" role="status">
                <span class="visually-hidden">Loading news...</span>
            </div>
            <p class="mt-3">Loading news articles...</p>
        </div>
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-4" id="loadMoreContainer" style="display: none;">
        <button class="btn btn-primary-custom" onclick="loadMoreNews()">
            <i class="fas fa-plus me-2"></i>Load More News
        </button>
    </div>

    <!-- No News Message -->
    <div class="no-news" id="noNewsMessage" style="display: none;">
        <div class="no-news-icon">
            <i class="fas fa-newspaper"></i>
        </div>
        <h4>No News Available</h4>
        <p class="text-muted">Check back later for updates and announcements.</p>
    </div>
</div>

<!-- Individual News Article Modal -->
<div class="modal fade modal-custom" id="articleModal" tabindex="-1" aria-labelledby="articleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--gradient-red);">
                <h5 class="modal-title text-white" id="articleModalLabel">
                    <i class="fas fa-newspaper me-2"></i>News Article
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="articleModalContent">
                <!-- Article content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary-custom" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
                <button type="button" class="btn btn-outline-success" onclick="shareArticle()">
                    <i class="fas fa-share-alt me-2"></i>Share
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allNews = [];
    let currentFilter = 'all';
    let currentPage = 1;
    const pageSize = 6;

    // Load news on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadNews();
        checkForNewNews(); // Check if there are new news to show badge
    });

    async function loadNews() {
        try {
            const response = await fetch('/api/news/latest?limit=50');
            const data = await response.json();
            
            if (data.success && data.news.length > 0) {
                allNews = data.news;
                displayNews(currentPage, currentFilter);
                
                if (allNews.length > pageSize) {
                    document.getElementById('loadMoreContainer').style.display = 'block';
                }
                
                document.getElementById('noNewsMessage').style.display = 'none';
            } else {
                document.getElementById('allNewsContainer').innerHTML = `
                    <div class="col-12 no-news">
                        <div class="no-news-icon">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <h4>No News Available</h4>
                        <p class="text-muted">Check back later for updates and announcements.</p>
                    </div>
                `;
                document.getElementById('loadMoreContainer').style.display = 'none';
                document.getElementById('noNewsMessage').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading news:', error);
            document.getElementById('allNewsContainer').innerHTML = `
                <div class="col-12 text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h5>Error Loading News</h5>
                    <p>Please try again later.</p>
                </div>
            `;
        }
    }

    function displayNews(page = 1, filter = 'all') {
        let filteredNews = allNews;
        
        // Apply filters
        if (filter === 'featured') {
            filteredNews = allNews.filter(article => article.is_featured);
        } else if (filter === 'recent') {
            // Show last 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            filteredNews = allNews.filter(article => {
                const articleDate = new Date(article.published_at || article.created_at);
                return articleDate >= thirtyDaysAgo;
            });
        }
        
        // Pagination
        const startIndex = (page - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const newsToShow = filteredNews.slice(0, endIndex);
        
        // Display news
        const newsContainer = document.getElementById('allNewsContainer');
        
        if (newsToShow.length === 0) {
            newsContainer.innerHTML = `
                <div class="col-12 no-news">
                    <div class="no-news-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <h4>No News Available</h4>
                    <p class="text-muted">No news articles match your filter.</p>
                </div>
            `;
            document.getElementById('loadMoreContainer').style.display = 'none';
            return;
        }
        
        let newsHTML = '';
        
        newsToShow.forEach((article, index) => {
            const articleDate = new Date(article.published_at || article.created_at);
            const formattedDate = articleDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            newsHTML += `
                <div class="col-lg-4 col-md-6 news-article" style="animation-delay: ${index * 0.1}s">
                    <div class="article-card ${article.is_featured ? 'article-featured' : ''}">
                        ${article.image_url ? `
                        <img src="${article.image_url}" alt="${article.title}" 
                             class="article-image" 
                             onerror="this.src='https://via.placeholder.com/400x250?text=KUCCPS+News'">
                        ` : `
                        <div class="article-image" style="background: var(--gradient-red); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-newspaper fa-3x text-white"></i>
                        </div>
                        `}
                        
                        <div class="article-body">
                            ${article.is_featured ? `
                            <span class="badge bg-warning mb-2">
                                <i class="fas fa-star me-1"></i>Featured
                            </span>
                            ` : ''}
                            
                            <h3 class="article-title">${article.title}</h3>
                            <p class="article-content">${article.excerpt || article.content.substring(0, 150)}...</p>
                            
                            <div class="article-meta">
                                <div>
                                    <span class="article-date">
                                        <i class="fas fa-calendar me-1"></i>${formattedDate}
                                    </span>
                                    <span class="article-views ms-3">
                                        <i class="fas fa-eye me-1"></i>${article.views || 0}
                                    </span>
                                </div>
                                <button class="read-more-btn" onclick="viewArticle('${article._id}')">
                                    Read More <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        newsContainer.innerHTML = newsHTML;
        
        // Show/hide load more button
        if (filteredNews.length > endIndex) {
            document.getElementById('loadMoreContainer').style.display = 'block';
        } else {
            document.getElementById('loadMoreContainer').style.display = 'none';
        }
    }

    function filterNews(filter) {
        currentFilter = filter;
        currentPage = 1;
        
        // Update active button
        document.querySelectorAll('.news-filters .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        displayNews(currentPage, filter);
    }

    function loadMoreNews() {
        currentPage++;
        displayNews(currentPage, currentFilter);
    }

    async function viewArticle(articleId) {
        try {
            // Find article in loaded news
            const article = allNews.find(a => a._id === articleId);
            if (!article) return;
            
            // Increment view count
            await fetch(`/api/news/increment-views/${articleId}`, { method: 'POST' });
            
            const articleDate = new Date(article.published_at || article.created_at);
            const formattedDate = articleDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let articleHTML = `
                <div class="article-view">
                    ${article.is_featured ? `
                    <div class="alert alert-warning">
                        <i class="fas fa-star me-2"></i>This is a featured article
                    </div>
                    ` : ''}
                    
                    <div class="text-center mb-4">
                        ${article.image_url ? `
                        <img src="${article.image_url}" alt="${article.title}" 
                             class="img-fluid rounded" style="max-height: 400px; object-fit: cover;"
                             onerror="this.src='https://via.placeholder.com/800x400?text=KUCCPS+News'">
                        ` : ''}
                    </div>
                    
                    <h2 class="mb-3">${article.title}</h2>
                    
                    <div class="article-meta mb-4">
                        <span class="text-muted">
                            <i class="fas fa-calendar me-1"></i>Published: ${formattedDate}
                        </span>
                        <span class="text-muted ms-3">
                            <i class="fas fa-user me-1"></i>By: ${article.created_by || 'KUCCPS Admin'}
                        </span>
                        <span class="text-muted ms-3">
                            <i class="fas fa-eye me-1"></i>Views: ${article.views || 0}
                        </span>
                    </div>
                    
                    <div class="article-content" style="line-height: 1.8; font-size: 1.1rem;">
                        ${article.content.replace(/\n/g, '<br>')}
                    </div>
                    
                    ${article.external_link ? `
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-link me-2"></i>
                        <strong>External Source:</strong>
                        <a href="${article.external_link}" target="_blank" class="alert-link ms-2">
                            ${article.external_link}
                        </a>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('articleModalContent').innerHTML = articleHTML;
            document.getElementById('articleModalLabel').innerHTML = `
                <i class="fas fa-newspaper me-2"></i>${article.title.substring(0, 50)}...
            `;
            
            const articleModal = new bootstrap.Modal(document.getElementById('articleModal'));
            articleModal.show();
            
        } catch (error) {
            console.error('Error viewing article:', error);
            alert('Error loading article. Please try again.');
        }
    }

    function shareArticle() {
        const articleTitle = document.getElementById('articleModalLabel').textContent;
        const articleUrl = window.location.href;
        
        if (navigator.share) {
            navigator.share({
                title: articleTitle,
                text: 'Check out this KUCCPS news article',
                url: articleUrl
            });
        } else {
            // Fallback: Copy to clipboard
            navigator.clipboard.writeText(`${articleTitle}\n${articleUrl}`);
            alert('Link copied to clipboard!');
        }
    }

    function checkForNewNews() {
        // Check if user has seen news before
        const lastSeenNews = localStorage.getItem('lastSeenNews');
        const latestNews = allNews[0];
        
        if (latestNews && latestNews._id !== lastSeenNews) {
            // Show news badge
            const newsBadge = document.getElementById('newsBadge');
            const newsCountBadge = document.getElementById('newsCountBadge');
            
            if (newsBadge) {
                newsBadge.style.display = 'block';
                
                // Count unread news (articles published after last seen)
                if (lastSeenNews) {
                    const unreadCount = allNews.filter(article => {
                        return article._id !== lastSeenNews;
                    }).length;
                    
                    if (unreadCount > 0) {
                        newsCountBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        newsCountBadge.style.display = 'inline-block';
                    } else {
                        newsCountBadge.style.display = 'none';
                    }
                } else {
                    // First time - show all news as new
                    newsCountBadge.textContent = allNews.length > 99 ? '99+' : allNews.length;
                    newsCountBadge.style.display = 'inline-block';
                }
                
                // Pulse animation
                newsBadge.style.animation = 'pulse 2s infinite';
            }
        }
    }
</script>
{% endblock %}