{% extends "base.html" %}

{% block title %}Processing Your Payment{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Payment Processing Modal -->
    <div class="modal fade show" id="paymentProcessingModal" tabindex="-1" aria-labelledby="paymentProcessingModalLabel"
        aria-modal="true" data-bs-backdrop="static" data-bs-keyboard="false" style="display: block;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body text-center p-5">
                    <!-- Enhanced Processing Spinner -->
                    <div class="position-relative mb-5">
                        <div class="spinner-border text-primary" style="width: 5rem; height: 5rem;" role="status">
                            <span class="visually-hidden">Processing payment...</span>
                        </div>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <i class="fas fa-mobile-alt fa-2x text-primary opacity-75"></i>
                        </div>
                    </div>

                    <!-- Enhanced Processing Text -->
                    <h3 class="fw-bold mb-3 text-gradient text-primary">Processing Your Payment</h3>
                    <p class="lead mb-4" id="statusMessage">
                        <i class="fas fa-check-circle me-2 text-success"></i>
                        Payment confirmed! Generating your courses...
                    </p>

                    <!-- Enhanced Warning Card - CRITICAL MESSAGE -->
                    <div class="card border-danger bg-danger bg-opacity-10 mb-4">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="mb-0 fw-bold text-danger">
                                        ‚ö†Ô∏è DO NOT REFRESH OR CLOSE THIS PAGE
                                    </p>
                                    <small class="text-danger">
                                        Your money has been deducted successfully. Refreshing may delay your results.
                                        The page will update automatically when your courses are ready.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Reference -->
                    <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-receipt me-2 text-info"></i>
                            <div class="text-start">
                                <small class="text-muted">Transaction Reference:</small>
                                <p class="mb-0 fw-bold" id="transactionRef">{{ session.get('transaction_ref', 'Processing...') }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Progress Bar -->
                    <div class="mb-5">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted fw-medium">Course Generation Progress</small>
                            <small class="text-primary fw-bold" id="progressText">0%</small>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                role="progressbar" style="width: 0%; border-radius: 10px;" 
                                id="progressBar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Status Timeline -->
                    <div class="row g-3 mb-4" id="statusTimeline">
                        <div class="col-4">
                            <div class="text-center p-2">
                                <div class="mb-2">
                                    <div class="badge bg-success bg-opacity-10 text-success p-2 rounded-circle" 
                                         style="width: 40px; height: 40px; line-height: 26px;">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <small class="d-block fw-medium text-success" id="step1">Payment Confirmed</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-2">
                                <div class="mb-2">
                                    <div class="badge bg-primary bg-opacity-10 text-primary p-2 rounded-circle" 
                                         style="width: 40px; height: 40px; line-height: 26px;">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                </div>
                                <small class="d-block fw-medium" id="step2">Generating Courses</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-2">
                                <div class="mb-2">
                                    <div class="badge bg-secondary bg-opacity-10 text-secondary p-2 rounded-circle" 
                                         style="width: 40px; height: 40px; line-height: 26px;">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                                <small class="d-block fw-medium text-muted" id="step3">Ready to View</small>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Cancel Modal -->
<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-danger" id="confirmCancelModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Important!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                    <p class="mb-2 fw-bold">Your payment of KES {{ session.get('payment_amount', '200') }} has already been confirmed.</p>
                    <p class="mb-0">If you leave now, you can still access your results later using:</p>
                    <ul class="mt-2 mb-0">
                        <li><strong>Receipt Number:</strong> <span class="text-primary" id="confirmReceipt">{{ session.get('transaction_ref', 'Your transaction reference') }}</span></li>
                        <li><strong>Index Number:</strong> <span class="text-primary">{{ session.get('index_number', 'Your index number') }}</span></li>
                    </ul>
                </div>
                <p class="text-muted small">Go to the homepage and click "Already Made Payment" to verify and access your results anytime.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Waiting</button>
                <a href="/" class="btn btn-danger">Go to Homepage</a>
            </div>
        </div>
    </div>
</div>

<!-- Hidden div to store flow value for JavaScript -->
<div id="flow-data" data-flow="{{ flow }}" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Payment waiting page loaded');

        // Get flow from data attribute
        const flowData = document.getElementById('flow-data');
        const flow = flowData ? flowData.dataset.flow : '{{ flow }}';
        
        console.log('üìç Current flow:', flow);
        
        let checkCount = 0;
        const maxChecks = 120; // 4 minutes with 2-second intervals (increased for safety)
        let isProcessing = false;
        let startTime = Date.now();
        let checkInterval = 2000; // Start with 2 seconds
        let consecutiveErrors = 0;
        const maxConsecutiveErrors = 5;

        // Progress animation
        let progress = 0;
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        
        // Set initial state
        step1.innerHTML = '<span class="text-success">‚úì Payment Confirmed</span>';
        step2.innerHTML = '<span class="text-primary">Generating Courses</span>';
        
        const progressInterval = setInterval(() => {
            if (progress < 90 && !isProcessing && checkCount > 0) {
                // Progress increases more slowly as we go
                const increment = checkCount < 20 ? 1.5 : (checkCount < 40 ? 1.0 : 0.5);
                progress = Math.min(progress + increment, 90);
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', Math.round(progress));
                progressText.textContent = Math.round(progress) + '%';
            }
        }, 500);

        // Start checking if courses are ready
        checkCoursesReady();

        function checkCoursesReady() {
            if (isProcessing) return;

            checkCount++;
            console.log(`‚ö° Course ready check ${checkCount}/${maxChecks}`);

            // Use fetch with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            fetch(`/check-courses-ready/${flow}`, { 
                signal: controller.signal,
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Course ready status:', data);
                    consecutiveErrors = 0; // Reset error count on success

                    if (data.ready === true) {
                        // Courses are ready! Redirect to results
                        console.log('‚úÖ Courses are ready! Redirecting...');
                        
                        // Complete progress
                        clearInterval(progressInterval);
                        progress = 100;
                        progressBar.style.width = '100%';
                        progressBar.setAttribute('aria-valuenow', '100');
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-success');
                        progressText.textContent = '100%';
                        
                        // Update status
                        document.getElementById('statusMessage').innerHTML = `
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Courses generated successfully! Redirecting...
                        `;
                        
                        // Update timeline
                        step2.innerHTML = '<span class="text-success">‚úì Courses Generated</span>';
                        step3.innerHTML = '<span class="text-success">‚úì Ready to View</span>';
                        
                        // Update badges
                        document.querySelectorAll('#statusTimeline .badge').forEach((badge, index) => {
                            badge.className = 'badge bg-success bg-opacity-10 text-success p-2 rounded-circle';
                            badge.innerHTML = '<i class="fas fa-check"></i>';
                        });
                        
                        // Redirect after short delay
                        const redirectUrl = data.redirect_url || `/results/${flow}`;
                        console.log('üîó Redirecting to:', redirectUrl);
                        
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 1500);
                        
                    } else if (data.ready === false && data.should_redirect) {
                        // Session expired or error - redirect
                        console.log('‚ö†Ô∏è Redirect needed:', data);
                        const redirectUrl = data.redirect_url || '/';
                        
                        // Show warning before redirect
                        document.getElementById('statusMessage').innerHTML = `
                            <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Session expired. Redirecting...
                            </div>
                        `;
                        
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 2000);
                        
                    } else if (data.processing === true) {
                        // Processing in progress
                        console.log('‚è≥ Processing in progress...');
                        
                        // Update status message based on check count
                        updateStatusMessage(data.message);
                        
                        // Gradually increase check interval to reduce server load
                        if (checkCount > 30) {
                            checkInterval = 3000;
                        } else if (checkCount > 60) {
                            checkInterval = 4000;
                        } else if (checkCount > 90) {
                            checkInterval = 5000;
                        }
                        
                        if (checkCount < maxChecks) {
                            setTimeout(checkCoursesReady, checkInterval);
                        } else {
                            handleTimeout();
                        }
                        
                    } else {
                        // Not ready yet - continue checking
                        updateStatusMessage(data.message || 'Generating your courses...');
                        
                        if (checkCount < maxChecks) {
                            setTimeout(checkCoursesReady, checkInterval);
                        } else {
                            handleTimeout();
                        }
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    consecutiveErrors++;
                    console.error('Error checking courses:', error);
                    
                    if (consecutiveErrors >= maxConsecutiveErrors) {
                        // Too many errors, show warning but keep trying
                        document.getElementById('statusMessage').innerHTML = `
                            <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Connection issues detected. Still trying...
                            </div>
                        `;
                    }
                    
                    if (checkCount < maxChecks) {
                        // Exponential backoff for errors
                        const backoffDelay = Math.min(3000 * Math.pow(1.5, Math.floor(consecutiveErrors)), 10000);
                        setTimeout(checkCoursesReady, backoffDelay);
                    } else {
                        handleTimeout();
                    }
                });
        }

        function updateStatusMessage(message) {
            const statusMessage = document.getElementById('statusMessage');
            const baseMessage = message || 'Generating your personalized course list...';
            
            // Rotate through different messages to keep user engaged
            const messages = [
                'Analyzing your KCSE grades...',
                'Searching through thousands of courses...',
                'Calculating your cluster points...',
                'Matching you with suitable programs...',
                'Preparing your personalized results...',
                'Almost there! Finalizing your course list...'
            ];
            
            // Use custom message if provided, otherwise cycle through messages
            if (message && !message.includes('Please wait')) {
                statusMessage.innerHTML = `<i class="fas fa-spinner fa-spin me-2 text-primary"></i>${message}`;
            } else {
                const messageIndex = Math.min(Math.floor(checkCount / 10), messages.length - 1);
                statusMessage.innerHTML = `<i class="fas fa-spinner fa-spin me-2 text-primary"></i>${messages[messageIndex] || messages[0]}`;
            }
        }

        function handleTimeout() {
            console.log('‚è±Ô∏è Check timeout reached - showing fallback options');
            
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = `
                <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock fa-2x text-warning me-3"></i>
                        <div class="text-start">
                            <h5 class="mb-1 fw-bold text-warning">Still Processing</h5>
                            <p class="mb-2">Your payment is confirmed but course generation is taking longer than expected.</p>
                            <p class="mb-0 small">Don't worry! You can check your results later using:</p>
                            <p class="mb-0 mt-1">
                                <span class="badge bg-light text-dark p-2">Receipt: {{ session.get('transaction_ref', 'Your reference') }}</span><br>
                                <span class="badge bg-light text-dark p-2 mt-1">Index: {{ session.get('index_number', 'Your index') }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add buttons for fallback options
            const actionButtons = document.querySelector('.d-grid.gap-2.mt-4');
            if (actionButtons) {
                actionButtons.innerHTML = `
                    <a href="/verify-payment-page" class="btn btn-primary btn-lg py-2">
                        <i class="fas fa-search me-2"></i>Verify Payment Now
                    </a>
                    <button type="button" class="btn btn-outline-secondary btn-lg py-2" id="continueWaiting">
                        <i class="fas fa-hourglass-half me-2"></i>Continue Waiting
                    </button>
                    <a href="/" class="btn btn-outline-danger btn-lg py-2">
                        <i class="fas fa-home me-2"></i>Return Home
                    </a>
                `;
                
                document.getElementById('continueWaiting').addEventListener('click', function() {
                    // Reset and continue checking
                    checkCount = 0;
                    consecutiveErrors = 0;
                    checkInterval = 2000;
                    location.reload(); // Simple reload to reset the UI
                });
            }
            
            // Stop progress animation
            clearInterval(progressInterval);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-warning');
        }

        // Update transaction reference if available
        const transactionRef = document.getElementById('transactionRef');
        if (transactionRef && '{{ session.get('transaction_ref') }}') {
            transactionRef.textContent = '{{ session.get('transaction_ref') }}';
        }

        // Handle modal close prevention
        const modal = document.getElementById('paymentProcessingModal');
        if (modal) {
            modal.addEventListener('hide.bs.modal', function (e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        }

        // Update confirm modal with receipt
        const confirmReceipt = document.getElementById('confirmReceipt');
        if (confirmReceipt && '{{ session.get('transaction_ref') }}') {
            confirmReceipt.textContent = '{{ session.get('transaction_ref') }}';
        }
    });
</script>

<style>
    .modal-content {
        border-radius: 20px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
        border: none;
        overflow: hidden;
    }

    .modal-body {
        padding: 3rem !important;
    }

    .text-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .progress {
        overflow: visible;
        background-color: #e9ecef;
    }

    .progress-bar {
        position: relative;
        overflow: visible;
        transition: width 0.3s ease;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        right: -8px;
        top: -3px;
        width: 18px;
        height: 18px;
        background: white;
        border: 3px solid currentColor;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .alert {
        border-radius: 12px;
    }

    .modal-backdrop {
        opacity: 0.7 !important;
        backdrop-filter: blur(4px);
    }

    .card {
        border-radius: 16px;
    }

    .badge {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 12px;
    }

    .lead {
        font-size: 1.1rem;
        font-weight: 400;
        color: #6c757d;
    }

    .fw-bold {
        font-weight: 700 !important;
    }

    .small {
        font-size: 0.875rem;
    }

    .bg-opacity-10 {
        --bs-bg-opacity: 0.1;
    }

    /* Pulse animation for warning */
    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            opacity: 1;
        }
    }

    .border-danger {
        animation: pulse 2s infinite;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .modal-body {
            padding: 1.5rem !important;
        }
        
        .badge {
            width: 35px;
            height: 35px;
        }
        
        .btn-lg {
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}